/*! cybers-cafe 2020-04-16 */

var Movement=pc.createScript("movement");function findOffset(t,e,i,o){return t<e-o?i-1:t>e+o?i+1:i}Movement.attributes.add("camera",{type:"entity"}),Movement.attributes.add("power",{type:"number",default:150}),Movement.attributes.add("lookSpeed",{type:"number",default:.5,title:"Look Speed"}),Movement.attributes.add("panSpeed",{type:"number",default:.025,title:"Pan Speed"}),Movement.attributes.add("maxElevation",{type:"number",default:70}),Movement.prototype.tileGrid=[],Movement.prototype.isBodyFocused=function(){var t=document.activeElement==document.getElementsByTagName("BODY")[0],e=document.activeElement==document.getElementById("application-canvas");return t||e},Movement.prototype.findGridOffset=function(t,e,i){var o=this.tileGrid[e][e].getLocalPosition(),s=i/2,n={};return n.x=findOffset(t.x,o.x,e,s),n.z=findOffset(t.z,o.z,e,s),n},Movement.prototype.createTileEntity=function(t){var e=this.tile.clone();return e.enabled=!0,this.tile.getParent().addChild(e),t&&e.rigidbody.teleport(t.x,t.y,t.z),e},Movement.prototype.createTileGrid=function(t,e){for(var i=0;i<=2*t;i++){this.tileGrid[i]=[];for(var o=0;o<=2*t;o++){posX=(i-t)*e,posZ=(o-t)*e;var s=this.createTileEntity({x:posX,y:0,z:posZ});this.tileGrid[i][o]=s}}},Movement.prototype.initialize=function(){var t=this.app;this.mode="movement",this.inputEnabled=!0,this.viewPos=new pc.Vec3,this.targetViewPos=new pc.Vec3,this.tempVec=new pc.Vec3,this.distance=3,this.targetDistance=3,this.rotX=-180,this.rotY=0,this.targetRotX=0,this.targetRotY=0,this.quatX=new pc.Quat,this.quatY=new pc.Quat,this.transformStarted=!1;var e,i;this.hammer=Hammer(t.graphicsDevice.canvas,{prevent_default:!0,drag_max_touches:2,transform_min_scale:.08,transform_min_rotation:180,transform_always_block:!0,touch:!0,transform:!1,hold:!1,release:!1,swipe:!1,tap:!1}),this.hammer.on("dragstart",function(t){if(this.inputEnabled&&!this.transformStarted){var o=t.gesture,s=void 0!==o.touches?o.touches.length:1;this.panning=2===s,this.dragStarted=!0,e=o.center.pageX,i=o.center.pageY}}.bind(this)),this.hammer.on("dragend",function(t){this.dragStarted&&(this.dragStarted=!1,this.panning=!1)}.bind(this)),this.hammer.on("drag",function(t){if(this.inputEnabled){var o=t.gesture,s=o.center.pageX-e,n=o.center.pageY-i;this.panning?this.pan(s*-this.panSpeed,n*this.panSpeed):this.orbit(s*this.lookSpeed,n*this.lookSpeed),e=o.center.pageX,i=o.center.pageY}}.bind(this)),t.mouse.on(pc.input.EVENT_MOUSEMOVE,this.onMouseMove,this),t.mouse.on(pc.input.EVENT_MOUSEWHEEL,this.onMouseWheel,this),t.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),t.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this),t.mouse.disableContextMenu(),this.tile=this.app.root.findByName("Tile"),this.range=5,this.scale=50,this.createTileGrid(this.range,this.scale),this.locationX=0,this.locationZ=0,this.locationBreadcrumbVector=[0,0],this.locationUpdateRange=2,this.force=new pc.Vec3,this.entity.collision||console.error("First Person Movement script needs to have a 'collision' component"),this.entity.rigidbody&&this.entity.rigidbody.type===pc.BODYTYPE_DYNAMIC||console.error("First Person Movement script needs to have a DYNAMIC 'rigidbody' component");var o=t.context.root.findByName("Player");this.raycastEntity=o.script.raycast},Movement.prototype.update=function(t){var e=this.force,i=this.app,o=this.camera.forward,s=this.camera.right,n=0,r=0;this.inputEnabled&&this.isBodyFocused()&&((i.keyboard.isPressed(pc.KEY_A)||i.keyboard.isPressed(pc.KEY_LEFT))&&(n-=s.x,r-=s.z),(i.keyboard.isPressed(pc.KEY_D)||i.keyboard.isPressed(pc.KEY_RIGHT))&&(n+=s.x,r+=s.z),(i.keyboard.isPressed(pc.KEY_W)||i.keyboard.isPressed(pc.KEY_UP))&&(n+=o.x,r+=o.z),(i.keyboard.isPressed(pc.KEY_S)||i.keyboard.isPressed(pc.KEY_DOWN))&&(n-=o.x,r-=o.z)),0===e.x&&0===e.z||!this.isBodyFocused()||this.entity.rigidbody.applyForce(e),0===n&&0===r||(e.set(n,0,r).normalize().scale(this.power),this.entity.rigidbody.applyForce(e)),this.force.x=0,this.force.z=0,this.viewPos.lerp(this.viewPos,this.targetViewPos,t/.1),this.distance=pc.math.lerp(this.distance,this.targetDistance,t/.2),this.rotX=pc.math.lerp(this.rotX,this.targetRotX,t/.2),this.rotY=pc.math.lerp(this.rotY,this.targetRotY,t/.2),this.quatX.setFromAxisAngle(pc.Vec3.RIGHT,-this.rotY),this.quatY.setFromAxisAngle(pc.Vec3.UP,-this.rotX),this.quatY.mul(this.quatX),this.camera.setRotation(this.quatY);var a=this.findGridOffset(this.entity.getLocalPosition(),this.range,this.scale);this.locationX+=a.x-this.range,this.locationZ+=a.z-this.range;var h=MathUtils.zCantorPair(this.locationX,this.locationZ).toString(36);$("#location-div").html(h);var c=i.context.root.findByName("scene").script.network;this.locationBreadcrumbVector[0]+=a.x-this.range,this.locationBreadcrumbVector[1]+=a.z-this.range,(Math.abs(this.locationBreadcrumbVector[0])>this.locationUpdateRange||Math.abs(this.locationBreadcrumbVector[1])>this.locationUpdateRange)&&(console.log("Location Update"),c.updateLocation(),this.locationBreadcrumbVector=[0,0]),this.treadmillX(a.x),this.treadmillZ(a.z),null!=this.mousePosition&&"movement"==this.mode&&(this.hoverEntity=this.raycastEntity.framebuffer(this.mousePosition),this.hoverEntity&&"Hyperlink"==this.hoverEntity.name?document.body.style.cursor="pointer":"auto"!=document.body.style.cursor&&(document.body.style.cursor="auto",this.hoverEntity=null))},Movement.prototype.treadmillX=function(t){if(t!=this.range){console.log("begin tile shuffle X");for(var e=[],i=[],o=0;o<=2*this.range;o++)i[o]=this.tileGrid[t][o].getLocalPosition().clone();var s=t>this.range?1:-1,n=this.scale*this.range*s;for(o=0;o<=2*this.range;o++)i[o].x+=n;var r=this.range+this.range*s,a=this.range-this.range*s;for(e[r]=this.tileGrid[a],o=0;o<=2*this.range;o++)e[r][o].setLocalPosition(i[o]),e[r][o].rigidbody.teleport(i[o]);for(o=1;o<=2*this.range;o++)s>0?e[2*this.range-o]=this.tileGrid[2*this.range-o+1]:e[o]=this.tileGrid[o-1];this.tileGrid=e,console.log("finished tile shuffle X")}},Movement.prototype.treadmillZ=function(t){if(t!=this.range){console.log("begin tile shuffle Z");for(var e=[],i=[],o=0;o<=2*this.range;o++)i[o]=this.tileGrid[o][t].getLocalPosition().clone();var s=t>this.range?1:-1,n=this.scale*this.range*s;for(o=0;o<=2*this.range;o++)i[o].z+=n;var r=this.range+this.range*s,a=this.range-this.range*s;for(o=0;o<=2*this.range;o++)e[o]=[],e[o][r]=this.tileGrid[o][a],e[o][r].setLocalPosition(i[o]),e[o][r].rigidbody.teleport(i[o]);for(o=1;o<=2*this.range;o++)if(s>0)for(j=0;j<=2*this.range;j++)e[j][2*this.range-o]=this.tileGrid[j][2*this.range-o+1];else for(j=0;j<=2*this.range;j++)e[j][o]=this.tileGrid[j][o-1];this.tileGrid=e,console.log("finished tile shuffle Z")}},Movement.prototype.reset=function(t,e){this.viewPos.copy(t),this.targetViewPos.copy(t),this.distance=e,this.targetDistance=e,this.rotX=-180,this.rotY=0,this.targetRotX=0,this.targetRotY=0},Movement.prototype.pan=function(t,e){var i=this.camera.forward,o=this.camera.right,s=-o.x*t-i.x*e,n=-o.z*t-i.z*e;this.force.set(s,0,n).normalize().scale(this.power)},Movement.prototype.orbit=function(t,e){this.targetRotX+=t,this.targetRotY+=e,this.targetRotY=pc.math.clamp(this.targetRotY,-this.maxElevation,this.maxElevation)},Movement.prototype.onMouseMove=function(t){if(this.mousePosition||(this.mousePosition={x:null,y:null}),this.mousePosition.x=t.x,this.mousePosition.y=t.y,this.inputEnabled)if(t.buttons[pc.input.MOUSEBUTTON_LEFT])this.orbit(.2*t.dx,.2*t.dy);else if(t.buttons[pc.input.MOUSEBUTTON_RIGHT]){var e=this.distance/700;this.pan(t.dx*-e,t.dy*e)}},Movement.prototype.onMouseDown=function(t){t.buttons[pc.input.MOUSEBUTTON_LEFT]&&this.hoverEntity&&"Hyperlink"==this.hoverEntity.name&&(this.hyperlinkEntity=this.hoverEntity)},Movement.prototype.onMouseUp=function(t){if("movement"==this.mode&&this.hyperlinkEntity&&this.hyperlinkEntity==this.hoverEntity)for(var e in this.hyperlinkEntity.script.scripts){var i=this.hyperlinkEntity.script.scripts[e];if("Hyperlink"==i.entity.name){var o=i.entity.script.scripts[0].text;warp(o)}}this.hyperlinkEntity=null},Movement.prototype.enableInput=function(){this.inputEnabled=!0},Movement.prototype.disableInput=function(){this.inputEnabled=!1};