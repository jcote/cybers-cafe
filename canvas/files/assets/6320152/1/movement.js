/*! cybers-cafe 2017-05-11 */

function findOffset(a,b,c,d){return a<b-d?c-1:a>b+d?c+1:c}var Movement=pc.createScript("movement");Movement.attributes.add("camera",{type:"entity"}),Movement.attributes.add("power",{type:"number",default:150}),Movement.attributes.add("lookSpeed",{type:"number",default:.5,title:"Look Speed"}),Movement.attributes.add("panSpeed",{type:"number",default:.025,title:"Pan Speed"}),Movement.attributes.add("maxElevation",{type:"number",default:70}),Movement.prototype.tileGrid=[],Movement.prototype.isBodyFocused=function(){var a=document.activeElement==document.getElementsByTagName("BODY")[0],b=document.activeElement==document.getElementById("application-canvas");return a||b},Movement.prototype.findGridOffset=function(a,b,c){var d=this.tileGrid[b][b],e=d.getLocalPosition(),f=c/2,g={};return g.x=findOffset(a.x,e.x,b,f),g.z=findOffset(a.z,e.z,b,f),g},Movement.prototype.createTileEntity=function(a){var b=this.tile.clone();return b.enabled=!0,this.tile.getParent().addChild(b),a&&b.rigidbody.teleport(a.x,a.y,a.z),b},Movement.prototype.createTileGrid=function(a,b){for(var c=0;c<=2*a;c++){this.tileGrid[c]=[];for(var d=0;d<=2*a;d++){posX=(c-a)*b,posZ=(d-a)*b;var e=this.createTileEntity({x:posX,y:0,z:posZ});this.tileGrid[c][d]=e}}},Movement.prototype.initialize=function(){var a=this.app;this.inputEnabled=!0,this.viewPos=new pc.Vec3,this.targetViewPos=new pc.Vec3,this.tempVec=new pc.Vec3,this.distance=3,this.targetDistance=3,this.rotX=-180,this.rotY=0,this.targetRotX=0,this.targetRotY=0,this.quatX=new pc.Quat,this.quatY=new pc.Quat,this.transformStarted=!1;var b={prevent_default:!0,drag_max_touches:2,transform_min_scale:.08,transform_min_rotation:180,transform_always_block:!0,touch:!0,transform:!1,hold:!1,release:!1,swipe:!1,tap:!1};this.hammer=Hammer(a.graphicsDevice.canvas,b);var c,d;this.hammer.on("dragstart",function(a){if(this.inputEnabled&&!this.transformStarted){var b=a.gesture,e=void 0!==b.touches?b.touches.length:1;this.panning=2===e,this.dragStarted=!0,c=b.center.pageX,d=b.center.pageY}}.bind(this)),this.hammer.on("dragend",function(a){this.dragStarted&&(this.dragStarted=!1,this.panning=!1)}.bind(this)),this.hammer.on("drag",function(a){if(this.inputEnabled){var b=a.gesture,e=b.center.pageX-c,f=b.center.pageY-d;this.panning?this.pan(e*-this.panSpeed,f*this.panSpeed):this.orbit(e*this.lookSpeed,f*this.lookSpeed),c=b.center.pageX,d=b.center.pageY}}.bind(this)),a.mouse.on(pc.input.EVENT_MOUSEMOVE,this.onMouseMove,this),a.mouse.on(pc.input.EVENT_MOUSEWHEEL,this.onMouseWheel,this),a.mouse.disableContextMenu(),this.tile=this.app.root.findByName("Tile"),this.range=5,this.scale=50,this.createTileGrid(this.range,this.scale),this.locationX=0,this.locationZ=0,this.locationBreadcrumbVector=[0,0],this.locationUpdateRange=2,this.force=new pc.Vec3,this.entity.collision||console.error("First Person Movement script needs to have a 'collision' component"),this.entity.rigidbody&&this.entity.rigidbody.type===pc.BODYTYPE_DYNAMIC||console.error("First Person Movement script needs to have a DYNAMIC 'rigidbody' component")},Movement.prototype.update=function(a){var b=this.force,c=this.app,d=this.camera.forward,e=this.camera.right,f=0,g=0;this.inputEnabled&&this.isBodyFocused()&&((c.keyboard.isPressed(pc.KEY_A)||c.keyboard.isPressed(pc.KEY_LEFT))&&(f-=e.x,g-=e.z),(c.keyboard.isPressed(pc.KEY_D)||c.keyboard.isPressed(pc.KEY_RIGHT))&&(f+=e.x,g+=e.z),(c.keyboard.isPressed(pc.KEY_W)||c.keyboard.isPressed(pc.KEY_UP))&&(f+=d.x,g+=d.z),(c.keyboard.isPressed(pc.KEY_S)||c.keyboard.isPressed(pc.KEY_DOWN))&&(f-=d.x,g-=d.z)),0===b.x&&0===b.z||!this.isBodyFocused()||this.entity.rigidbody.applyForce(b),0===f&&0===g||(b.set(f,0,g).normalize().scale(this.power),this.entity.rigidbody.applyForce(b)),this.force.x=0,this.force.z=0,this.viewPos.lerp(this.viewPos,this.targetViewPos,a/.1),this.distance=pc.math.lerp(this.distance,this.targetDistance,a/.2),this.rotX=pc.math.lerp(this.rotX,this.targetRotX,a/.2),this.rotY=pc.math.lerp(this.rotY,this.targetRotY,a/.2),this.quatX.setFromAxisAngle(pc.Vec3.RIGHT,-this.rotY),this.quatY.setFromAxisAngle(pc.Vec3.UP,-this.rotX),this.quatY.mul(this.quatX),this.camera.setRotation(this.quatY);var h=this.findGridOffset(this.entity.getLocalPosition(),this.range,this.scale);this.locationX+=h.x-this.range,this.locationZ+=h.z-this.range;var i=MathUtils.zCantorPair(this.locationX,this.locationZ),j=i.toString(36);$("#location-div").html(j);var k=c.context.root.findByName("scene"),l=k.script.network;this.locationBreadcrumbVector[0]+=h.x-this.range,this.locationBreadcrumbVector[1]+=h.z-this.range,(Math.abs(this.locationBreadcrumbVector[0])>this.locationUpdateRange||Math.abs(this.locationBreadcrumbVector[1])>this.locationUpdateRange)&&(console.log("Location Update"),l.updateLocation(),this.locationBreadcrumbVector=[0,0]),this.treadmillX(h.x),this.treadmillZ(h.z)},Movement.prototype.treadmillX=function(a){if(a!=this.range){console.log("begin tile shuffle X");for(var b=[],c=[],d=0;d<=2*this.range;d++)c[d]=this.tileGrid[a][d].getLocalPosition().clone();var e=a>this.range?1:-1,f=this.scale*this.range*e;for(d=0;d<=2*this.range;d++)c[d].x+=f;var g=this.range+this.range*e,h=this.range-this.range*e;for(b[g]=this.tileGrid[h],d=0;d<=2*this.range;d++)b[g][d].setLocalPosition(c[d]),b[g][d].rigidbody.teleport(c[d]);for(d=1;d<=2*this.range;d++)e>0?b[2*this.range-d]=this.tileGrid[2*this.range-d+1]:b[d]=this.tileGrid[d-1];this.tileGrid=b,console.log("finished tile shuffle X")}},Movement.prototype.treadmillZ=function(a){if(a!=this.range){console.log("begin tile shuffle Z");for(var b=[],c=[],d=0;d<=2*this.range;d++)c[d]=this.tileGrid[d][a].getLocalPosition().clone();var e=a>this.range?1:-1,f=this.scale*this.range*e;for(d=0;d<=2*this.range;d++)c[d].z+=f;var g=this.range+this.range*e,h=this.range-this.range*e;for(d=0;d<=2*this.range;d++)b[d]=[],b[d][g]=this.tileGrid[d][h],b[d][g].setLocalPosition(c[d]),b[d][g].rigidbody.teleport(c[d]);for(d=1;d<=2*this.range;d++)if(e>0)for(j=0;j<=2*this.range;j++)b[j][2*this.range-d]=this.tileGrid[j][2*this.range-d+1];else for(j=0;j<=2*this.range;j++)b[j][d]=this.tileGrid[j][d-1];this.tileGrid=b,console.log("finished tile shuffle Z")}},Movement.prototype.reset=function(a,b){this.viewPos.copy(a),this.targetViewPos.copy(a),this.distance=b,this.targetDistance=b,this.rotX=-180,this.rotY=0,this.targetRotX=0,this.targetRotY=0},Movement.prototype.pan=function(a,b){var c=this.camera.forward,d=this.camera.right,e=-d.x*a-c.x*b,f=-d.z*a-c.z*b;this.force.set(e,0,f).normalize().scale(this.power)},Movement.prototype.orbit=function(a,b){this.targetRotX+=a,this.targetRotY+=b,this.targetRotY=pc.math.clamp(this.targetRotY,-this.maxElevation,this.maxElevation)},Movement.prototype.onMouseMove=function(a){if(this.inputEnabled)if(a.buttons[pc.input.MOUSEBUTTON_LEFT])this.orbit(.2*a.dx,.2*a.dy);else if(a.buttons[pc.input.MOUSEBUTTON_RIGHT]){var b=this.distance/700;this.pan(a.dx*-b,a.dy*b)}},Movement.prototype.enableInput=function(){this.inputEnabled=!0},Movement.prototype.disableInput=function(){this.inputEnabled=!1};