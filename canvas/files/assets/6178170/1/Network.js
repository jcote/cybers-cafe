/*! cybers-cafe 2020-04-12 */

var Network=pc.createScript("network");function QueueItem(t,e){this.type=t,this.resource=e}Network.id=null,Network.socket=null,Network.scale=50,Network.prototype.initialize=function(){this.player=this.app.root.findByName("Player"),this.other=this.app.root.findByName("Other"),this.queue=new Queue,this.isQueueRunning=!1,this.progress=0,this.progressExpected=0,this.origin=[0,0];var t=io.connect(CYBERS_CAFE_SERVICE_URL);Network.socket=t,this.app.entities={},t.emit("initialize");var e=this;t.on("playerData",function(t){console.log("Connected."),e.initializePlayers(t)}),t.on("playerJoined",function(t){e.addPlayer(t)}),t.on("playerMoved",function(t){e.movePlayer(t)}),t.on("playerDropped",function(t){e.removePlayer(t)}),t.on("expect",function(t){e.progressExpected+=t}),t.on("addAsset",function(t){console.log("Add Asset "+t.asset.id),e.app.assets.get(t.asset.id)||(e.queue.enqueue(new QueueItem("asset",t.asset)),e.isQueueRunning||e.popQueue())}),t.on("addEntity",function(t){console.log("Add Entity "+t.entity.id),t.entity.id in e.app.entities||(e.queue.enqueue(new QueueItem("entity",t.entity)),e.isQueueRunning||e.popQueue())}),setInterval(function(){e.initialized&&t.emit("ping",Network.id)},1e3)},Network.prototype.initializePlayers=function(t){for(this.players=t.players,Network.id=t.id,i=0;i<this.players.length;i++)i===Network.id||this.players[i].deleted||(this.players[i].entity=this.createPlayerEntity(t.players[i]));this.initialized=!0,console.log("initialized")},Network.prototype.addPlayer=function(t){this.players.push(t),this.players[this.players.length-1].entity=this.createPlayerEntity()},Network.prototype.movePlayer=function(t){if(this.initialized&&this.players[t.id]&&!this.players[t.id].deleted){var e=MathUtils.getRelativePosition(t.location,t.position,this.origin,Network.scale);this.players[t.id].entity.rigidbody.teleport(e[0],e[1],e[2])}},Network.prototype.removePlayer=function(t){t in this.players&&this.players[t].entity&&(this.players[t].entity.destroy(),delete this.players[t])},Network.prototype.createPlayerEntity=function(t){var e=this.other.clone();if(e.enabled=!0,this.other.getParent().addChild(e),t){var i=MathUtils.getRelativePosition(t.location,t.position,this.origin,Network.scale);e.rigidbody.teleport(i[0],i[1],i[2])}return e},Network.prototype.update=function(t){this.updatePosition()},Network.prototype.updatePosition=function(){if(this.initialized){var t=this.player.getPosition(),e=MathUtils.getAbsolutePosition(t.data,this.origin,Network.scale);Network.socket.emit("positionUpdate",{id:Network.id,location:e.location,position:e.position})}},Network.prototype.updateLocation=function(){if(this.initialized){var t=this.player.getPosition(),e=MathUtils.getAbsolutePosition(t.data,this.origin,Network.scale);console.log("Update location: "+e.location),Network.socket.emit("locationUpdate",{location:e.location})}},Network.prototype.popQueue=function(){if(this.isQueueRunning||($("#progress-inner-div").attr("aria-valuenow",0).css("width",0),$("#progress-div").css("visibility","visible"),this.isQueueRunning=!0),this.progress++,this.progressExpected){var t=this.progress/this.progressExpected*100;$("#progress-inner-div").attr("aria-valuenow",t).css("width",t+"%")}var e=this.queue.dequeue();if(e&&("asset"==e.type?this.addAsset(e.resource):"entity"==e.type?this.addEntity(e.resource):(console.log("Unknown QueueItem type: "+e.type),this.popQueue())),0===this.queue.getLength()){this.isQueueRunning=!1;var i=this;setTimeout(function(){i.isQueueRunning||(i.progress=0,i.progressExpected=0,$("#progress-inner-div").attr("aria-valuenow",100).css("width","100%"),setTimeout(function(){$("#progress-div").css("visibility","hidden"),$("#progress-inner-div").attr("aria-valuenow",0).css("width","0%")},3e3))},5e3)}},Network.prototype.addAsset=function(t){var e=new pc.Asset(t.name,t.type,t.file,t.data);e.id=parseInt(t.id),e.preload=!!t.preload&&t.preload,e.tags.add(t.tags),e.revision=t.revision;try{this.app.assets.add(e)}catch(t){console.log("Asset error: "+t)}var i=this,o=function(){i.popQueue()};if(e.resource)o();else{e.once("load",o);try{this.app.assets.load(e)}catch(t){console.log("Asset error: "+t)}}},Network.prototype.addEntity=function(t){this.popQueue();var e=new pc.Entity,i=pc.Application.getApplication("application-canvas").context.root.findByName("Player").script.movement;for(var o in t.components)"camera"!=o&&e.addComponent(o,t.components[o]);if(e.id=t.id,e.objectId=t.objectId,e.name=t.name,0!=this.origin[0]||0!=this.origin[1]){var s=[i.locationX-this.origin[0],i.locationZ-this.origin[1]],n=[t.location[0]-this.origin[0],t.location[1]-this.origin[1]],r=MathUtils.getRelativePosition(n,t.position,s,Network.scale);e.setLocalPosition(r[0],r[1],r[2])}else{r=MathUtils.getRelativePosition(t.location,t.position,this.origin,Network.scale);e.setLocalPosition(r[0],r[1],r[2])}e.setLocalScale(t.scale[0],t.scale[1],t.scale[2]),e.setEulerAngles(t.rotation[0],t.rotation[1],t.rotation[2]),e.rigidbody&&e.rigidbody.teleport(r[0],r[1],r[2]),this.app.root.addChild(e),this.app.entities[e.id]=e};