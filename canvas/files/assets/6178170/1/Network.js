/*! cybers-cafe 2017-05-11 */

function QueueItem(a,b){this.type=a,this.resource=b}var Network=pc.createScript("network");Network.id=null,Network.socket=null,Network.scale=50,Network.prototype.initialize=function(){this.player=this.app.root.findByName("Player"),this.other=this.app.root.findByName("Other"),this.queue=new Queue,this.isQueueRunning=!1,this.progress=0,this.progressExpected=0,this.origin=[0,0];var a=io.connect("http://service.cybers.cafe:59595/");Network.socket=a,this.app.entities={},a.emit("initialize");var b=this;a.on("playerData",function(a){console.log("Connected."),b.initializePlayers(a)}),a.on("playerJoined",function(a){b.addPlayer(a)}),a.on("playerMoved",function(a){b.movePlayer(a)}),a.on("playerDropped",function(a){b.removePlayer(a)}),a.on("expect",function(a){b.progressExpected+=a}),a.on("addAsset",function(a){console.log("Add Asset"),b.app.assets.get(a.asset.id)||(b.queue.enqueue(new QueueItem("asset",a.asset)),b.isQueueRunning||b.popQueue())}),a.on("addEntity",function(a){console.log("Add Entity"),a.entity.id in b.app.entities||(b.queue.enqueue(new QueueItem("entity",a.entity)),b.isQueueRunning||b.popQueue())}),setInterval(function(){b.initialized&&a.emit("ping",Network.id)},1e3)},Network.prototype.initializePlayers=function(a){for(this.players=a.players,Network.id=a.id,i=0;i<this.players.length;i++)i===Network.id||this.players[i].deleted||(this.players[i].entity=this.createPlayerEntity(a.players[i]));this.initialized=!0,console.log("initialized")},Network.prototype.addPlayer=function(a){this.players.push(a),this.players[this.players.length-1].entity=this.createPlayerEntity()},Network.prototype.movePlayer=function(a){if(this.initialized&&this.players[a.id]&&!this.players[a.id].deleted){var b=MathUtils.getRelativePosition(a.location,a.position,this.origin,Network.scale);this.players[a.id].entity.rigidbody.teleport(b[0],b[1],b[2])}},Network.prototype.removePlayer=function(a){a in this.players&&this.players[a].entity&&(this.players[a].entity.destroy(),delete this.players[a])},Network.prototype.createPlayerEntity=function(a){var b=this.other.clone();if(b.enabled=!0,this.other.getParent().addChild(b),a){var c=MathUtils.getRelativePosition(a.location,a.position,this.origin,Network.scale);b.rigidbody.teleport(c[0],c[1],c[2])}return b},Network.prototype.update=function(a){this.updatePosition()},Network.prototype.updatePosition=function(){if(this.initialized){var a=this.player.getPosition(),b=MathUtils.getAbsolutePosition(a.data,this.origin,Network.scale);Network.socket.emit("positionUpdate",{id:Network.id,location:b.location,position:b.position})}},Network.prototype.updateLocation=function(){if(this.initialized){var a=this.player.getPosition(),b=MathUtils.getAbsolutePosition(a.data,this.origin,Network.scale);console.log("Update location: "+b.location),Network.socket.emit("locationUpdate",{location:b.location})}},Network.prototype.popQueue=function(){if(0===this.queue.getLength()){this.isQueueRunning=!1;var a=this;return void setTimeout(function(){a.isQueueRunning||(a.progress=0,a.progressExpected=0,$("#progress-inner-div").attr("aria-valuenow",100).css("width","100%"),setTimeout(function(){$("#progress-div").css("visibility","hidden")},2e3))},1e4)}if(this.isQueueRunning||($("#progress-inner-div").attr("aria-valuenow",0).css("width",0),$("#progress-div").css("visibility","visible")),this.isQueueRunning=!0,this.progress++,this.progressExpected){var b=this.progress/this.progressExpected*100;$("#progress-inner-div").attr("aria-valuenow",b).css("width",b+"%")}var c=this.queue.dequeue();"asset"==c.type?this.addAsset(c.resource):"entity"==c.type?this.addEntity(c.resource):(console.log("Unknown QueueItem type: "+c.type),this.popQueue())},Network.prototype.addAsset=function(a){var b=new pc.Asset(a.name,a.type,a.file,a.data);b.id=parseInt(a.id),b.preload=!!a.preload&&a.preload,b.tags.add(a.tags),b.revision=a.revision;try{this.app.assets.add(b)}catch(a){console.log("Asset error: "+a)}var c=this,d=function(){c.popQueue()};if(b.resource)d();else{b.once("load",d);try{this.app.assets.load(b)}catch(a){console.log("Asset error: "+a)}}},Network.prototype.addEntity=function(a){var b=new pc.Entity;for(var c in a.components)"camera"!=c&&b.addComponent(c,a.components[c]);b.id=a.id,b.objectId=a.objectId,b.name=a.name;var d=MathUtils.getRelativePosition(a.location,a.position,this.origin,Network.scale);b.setLocalPosition(d[0],d[1],d[2]),b.setLocalScale(a.scale[0],a.scale[1],a.scale[2]),b.setEulerAngles(a.rotation[0],a.rotation[1],a.rotation[2]),b.rigidbody&&b.rigidbody.teleport(d[0],d[1],d[2]),this.app.root.addChild(b),this.app.entities[b.id]=b,this.popQueue()};