/*! cybers-cafe 2020-04-04 */

var Network=pc.createScript("network");function QueueItem(e,t){this.type=e,this.resource=t}Network.id=null,Network.socket=null,Network.scale=50,Network.prototype.initialize=function(){this.player=this.app.root.findByName("Player"),this.other=this.app.root.findByName("Other"),this.queue=new Queue,this.isQueueRunning=!1,this.progress=0,this.progressExpected=0,this.origin=[0,0];var e=io.connect(CYBERS_CAFE_SERVICE_URL);Network.socket=e,this.app.entities={},e.emit("initialize");var t=this;e.on("playerData",function(e){console.log("Connected."),t.initializePlayers(e)}),e.on("playerJoined",function(e){t.addPlayer(e)}),e.on("playerMoved",function(e){t.movePlayer(e)}),e.on("playerDropped",function(e){t.removePlayer(e)}),e.on("expect",function(e){t.progressExpected+=e}),e.on("addAsset",function(e){console.log("Add Asset"),t.app.assets.get(e.asset.id)||(t.queue.enqueue(new QueueItem("asset",e.asset)),t.isQueueRunning||t.popQueue())}),e.on("addEntity",function(e){console.log("Add Entity"),e.entity.id in t.app.entities||(t.queue.enqueue(new QueueItem("entity",e.entity)),t.isQueueRunning||t.popQueue())}),setInterval(function(){t.initialized&&e.emit("ping",Network.id)},1e3)},Network.prototype.initializePlayers=function(e){for(this.players=e.players,Network.id=e.id,i=0;i<this.players.length;i++)i===Network.id||this.players[i].deleted||(this.players[i].entity=this.createPlayerEntity(e.players[i]));this.initialized=!0,console.log("initialized")},Network.prototype.addPlayer=function(e){this.players.push(e),this.players[this.players.length-1].entity=this.createPlayerEntity()},Network.prototype.movePlayer=function(e){if(this.initialized&&this.players[e.id]&&!this.players[e.id].deleted){var t=MathUtils.getRelativePosition(e.location,e.position,this.origin,Network.scale);this.players[e.id].entity.rigidbody.teleport(t[0],t[1],t[2])}},Network.prototype.removePlayer=function(e){e in this.players&&this.players[e].entity&&(this.players[e].entity.destroy(),delete this.players[e])},Network.prototype.createPlayerEntity=function(e){var t=this.other.clone();if(t.enabled=!0,this.other.getParent().addChild(t),e){var i=MathUtils.getRelativePosition(e.location,e.position,this.origin,Network.scale);t.rigidbody.teleport(i[0],i[1],i[2])}return t},Network.prototype.update=function(e){this.updatePosition()},Network.prototype.updatePosition=function(){if(this.initialized){var e=this.player.getPosition(),t=MathUtils.getAbsolutePosition(e.data,this.origin,Network.scale);Network.socket.emit("positionUpdate",{id:Network.id,location:t.location,position:t.position})}},Network.prototype.updateLocation=function(){if(this.initialized){var e=this.player.getPosition(),t=MathUtils.getAbsolutePosition(e.data,this.origin,Network.scale);console.log("Update location: "+t.location),Network.socket.emit("locationUpdate",{location:t.location})}},Network.prototype.popQueue=function(){if(0!==this.queue.getLength()){if(this.isQueueRunning||($("#progress-inner-div").attr("aria-valuenow",0).css("width",0),$("#progress-div").css("visibility","visible")),this.isQueueRunning=!0,this.progress++,this.progressExpected){var e=this.progress/this.progressExpected*100;$("#progress-inner-div").attr("aria-valuenow",e).css("width",e+"%")}var t=this.queue.dequeue();"asset"==t.type?this.addAsset(t.resource):"entity"==t.type?this.addEntity(t.resource):(console.log("Unknown QueueItem type: "+t.type),this.popQueue())}else{this.isQueueRunning=!1;var i=this;setTimeout(function(){i.isQueueRunning||(i.progress=0,i.progressExpected=0,$("#progress-inner-div").attr("aria-valuenow",100).css("width","100%"),setTimeout(function(){$("#progress-div").css("visibility","hidden")},2e3))},1e4)}},Network.prototype.addAsset=function(e){var t=new pc.Asset(e.name,e.type,e.file,e.data);t.id=parseInt(e.id),t.preload=!!e.preload&&e.preload,t.tags.add(e.tags),t.revision=e.revision;try{this.app.assets.add(t)}catch(e){console.log("Asset error: "+e)}var i=this,o=function(){i.popQueue()};if(t.resource)o();else{t.once("load",o);try{this.app.assets.load(t)}catch(e){console.log("Asset error: "+e)}}},Network.prototype.addEntity=function(e){var t=new pc.Entity;for(var i in e.components)"camera"!=i&&t.addComponent(i,e.components[i]);t.id=e.id,t.objectId=e.objectId,t.name=e.name;var o=MathUtils.getRelativePosition(e.location,e.position,this.origin,Network.scale);t.setLocalPosition(o[0],o[1],o[2]),t.setLocalScale(e.scale[0],e.scale[1],e.scale[2]),t.setEulerAngles(e.rotation[0],e.rotation[1],e.rotation[2]),t.rigidbody&&t.rigidbody.teleport(o[0],o[1],o[2]),this.app.root.addChild(t),this.app.entities[t.id]=t,this.popQueue()};