/*! cybers-cafe 2020-04-10 */

"use strict";var draweropen=!1;function drawer(){draweropen?(setTimeout(function(){$("#interface-div").css("visibility","hidden")},400),$("#drawer-icon-div").css("visibility","visible"),$("#interface-div").animate({opacity:0},400),draweropen=!1):($("#interface-div").css("visibility","visible"),$("#drawer-icon-div").css("visibility","hidden"),$("#interface-div").animate({opacity:1},400),draweropen=!0)}$(function(){document.getElementById("warpToButton").addEventListener("click",function(e){var t=$("#warpToInput").val();if(t.match(/^[0-9a-zA-Z]+$/)){var n=pc.Application.getApplication("application-canvas"),i=n.context,o=i.root.findByName("Player").script.movement,a=i.root.findByName("scene").script.network,c=parseInt(t,36),l=MathUtils.zReverseCantorPair(c);console.log("##### Warp to: ["+l+"] ("+c+") '"+t+"'"),console.log("Current loc: "+o.locationX+", "+o.locationZ),console.log("Current breadcrumb: "+o.locationBreadcrumbVector[0]+", "+o.locationBreadcrumbVector[1]),console.log("Current origin: "+a.origin);var d=[l[0]-a.origin[0],l[1]-a.origin[1]];o.locationX=l[0],o.locationZ=l[1],o.createTileGrid(o.range,o.scale),o.locationBreadcrumbVector[0]+=d[0],o.locationBreadcrumbVector[1]+=d[1],a.origin[0]=l[0],a.origin[1]=l[1],Object.keys(n.entities).forEach(function(e){var t=n.entities[e].getLocalPosition(),i={};i.x=t.x-d[0]*Network.scale,i.y=t.y,i.z=t.z-d[1]*Network.scale,Math.abs(l[0]-i.x)<50||Math.abs(l[1]-i.z)<50?"rigidbody"in n.entities[e]?n.entities[e].rigidbody.teleport(i.x,i.y,i.z):n.entities[e].translate(-d[0]*Network.scale,0,-d[1]*Network.scale):(n.entities[e].destroy(),delete n.entities[e])}),a.players||(a.players=[]),Object.keys(a.players).forEach(function(e){if("entity"in a.players[e]){var t=a.players[e].entity.getLocalPosition(),n={};n.x=t.x-d[0]*Network.scale,n.y=t.y,n.z=t.z-d[1]*Network.scale,Math.abs(l[0]-n.x)<50||Math.abs(l[1]-n.z)<50?a.players[e].entity.rigidbody.teleport(n.x,n.y,n.z):a.players[e].entity.destroy()}}),a.player.rigidbody.teleport(0,.5,0),a.updatePosition()}else alert("Alphanumeric names only.")},!1)});var sections=["createSection","editSection"];function selectSection(e){for(var t=0;t<sections.length;t++)document.getElementById(sections[t]).style.display="none";document.getElementById(e).style.display="block"}var createForms=["createEntityImageForm","createEntityModelForm","createEntityHyperlinkForm"],editForms=["editEntityMoveForm","editEntityRotateForm","editEntityScaleForm"];function selectForm(e){for(var t=e.startsWith("create")?createForms:editForms,n=0;n<t.length;n++)document.getElementById(t[n]).style.display="none";document.getElementById(e).style.display="block"}function entityPlacement(e){var t=e.target,n=t.entry,i=pc.Application.getApplication("application-canvas").context,o=i.root.findByName("Player"),a=o.script.movement,c=o.script.raycast,l=o.script.transform;a.disableInput(),c.enableInput(),l.disableInput(),c.modeRaycast(),document.getElementById("modeLabel").innerHTML="Placement Mode",document.getElementById("modeLabel").className="label label-mode-placement";var d=i.root.findByName("scene").script.network,r=!1;c.on("hit",function(e){if(!r){r=!0,"assets"in n&&Object.keys(n.assets).forEach(function(e){d.queue.enqueue(new QueueItem("asset",n.assets[e])),d.isQueueRunning||d.popQueue()});var i=[e.point.x,e.point.y,e.point.z],o=MathUtils.getAbsolutePosition(i,d.origin,a.scale);if(0!=d.origin[0]||0!=d.origin[1]){var l=[a.locationX-d.origin[0],a.locationZ-d.origin[1]],s=MathUtils.getAbsolutePosition(i,l,Network.scale);o.position=s.position}n.entity.location=o.location,n.entity.position=o.position,d.queue.enqueue(new QueueItem("entity",n.entity)),d.isQueueRunning||d.popQueue(),a.enableInput(),c.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement",t.className+=" disabled";var m=document.getElementById("createFormResultContainer");m.appendChild(document.createTextNode("Placing entity..."));var u=new FormData;u.append("locX",o.location[0]),u.append("locZ",o.location[1]),u.append("posX",o.position[0]),u.append("posY",o.position[1]),u.append("posZ",o.position[2]);var p=new XMLHttpRequest;p.open("PUT","api/entities/position/"+n.entity.id,!0),p.onload=function(e){if(200==p.status){var t=JSON.parse(p.responseText);m.appendChild(document.createTextNode(t.message))}else m.appendChild(document.createTextNode("Error occurred. ")),t&&m.appendChild(document.createTextNode(t.message))},p.send(u)}})}function createPlacementButton(e,t){var n=document.createElement("button");n.type="button",n.className="list-group-item",n.appendChild(document.createTextNode(e.name+" : "+e.id)),n.addEventListener("click",entityPlacement),n.entry={entity:e,assets:t},document.getElementById("entityChooseList").appendChild(n)}$(function(){var e=document.forms.namedItem("createEntityModel");e.addEventListener("submit",function(t){var n=document.getElementById("createFormResultContainer"),i=new FormData(e);n.innerHTML="Uploading...";var o=new XMLHttpRequest;o.open("POST","api/entities",!0),o.onload=function(e){if(200==o.status){var t=JSON.parse(o.responseText);n.appendChild(document.createTextNode(t.message)),t.records&&Object.keys(t.records).forEach(function(e){if("undefined"!=e){var i=t.records[e].objectId,o=t.entities[i];o.id=e,o.objectId=i,createPlacementButton(o,t.records[e].assetIds.reduce(function(e,n){return e[n]=t.assets[n],e},{})),n.appendChild(document.createTextNode("Ready to place entity..."))}})}else n.appendChild(document.createTextNode("Error occurred. "+t.message))},o.send(i),t.preventDefault()},!1)}),$(function(){var e=document.forms.namedItem("createEntityImage");e.addEventListener("submit",function(t){var n=document.getElementById("createFormResultContainer"),i=new FormData(e);n.innerHTML="Uploading...";var o=new XMLHttpRequest;o.open("POST","api/image",!0),o.onload=function(e){if(200==o.status){var t=JSON.parse(o.responseText);n.appendChild(document.createTextNode(t.message));var i=Object.keys(t.records)[0],a=t.records[i].objectId,c=t.entities[a],l=t.assets;c.id=i,c.objectId=t.records[i].objectId,createPlacementButton(c,l),n.appendChild(document.createTextNode("Ready to place entity..."))}else n.appendChild(document.createTextNode("Error occurred. "+t.message))},o.send(i),t.preventDefault()},!1)}),$(function(){var e=document.forms.namedItem("createEntityHyperlink");e.addEventListener("submit",function(t){var n=document.getElementById("createFormResultContainer"),i=new FormData(e);n.innerHTML="Uploading...";var o=new XMLHttpRequest;o.open("POST","api/hyperlink",!0),o.onload=function(e){if(200==o.status){var t=JSON.parse(o.responseText);n.appendChild(document.createTextNode(t.message));var i=Object.keys(t.records)[0],a=t.records[i].objectId,c=t.entities[a],l=t.assets;c.id=i,c.objectId=t.records[i].objectId,createPlacementButton(c,l),n.appendChild(document.createTextNode("Ready to place entity..."))}else n.appendChild(document.createTextNode("Error occurred. "+t.message))},o.send(i),t.preventDefault()},!1)}),$(function(){var e=document.forms.namedItem("editEntity");e.addEventListener("submit",function(t){var n=document.getElementById("editFormResultContainer"),i=new FormData(e),o=pc.Application.getApplication("application-canvas"),a=document.getElementById("editEntityId").value;if(!($.isNumeric(a)&&a in o.entities))return alert("Select an Entity first."),void t.preventDefault();var c=o.context.root.findByName("Player"),l=c.script.movement,d=o.context.root.findByName("scene").script.network,r=c.script.raycast,s=c.script.transform,m=[i.get("posX"),i.get("posY"),i.get("posZ")],u=MathUtils.getAbsolutePosition(m,d.origin,l.scale);i.set("locX",u.location[0]),i.set("locZ",u.location[1]),i.set("posX",u.position[0]),i.set("posY",u.position[1]),i.set("posZ",u.position[2]),n.innerHTML="Updating...",l.enableInput(),r.disableInput(),s.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement";var p=new XMLHttpRequest;p.open("PUT","api/entity/"+i.get("id"),!0),p.onload=function(e){var t=JSON.parse(p.responseText);200==p.status?n.innerHTML=t.message:n.innerHTML=void 0!=t?"Error occurred ("+p.status+"): <br />"+t.message:"Error occurred ("+p.status+"): <br />"+p.responseText},p.send(i),t.preventDefault()},!1)});var populateInputsForSelectedEntity=function(e){if(document.getElementById("editEntityTitle").value=e.name,"localPosition"in e&&(document.getElementById("editEntityPosX").value=e.localPosition.x,document.getElementById("editEntityPosY").value=e.localPosition.y,document.getElementById("editEntityPosZ").value=e.localPosition.z),"localRotation"in e){var t=e.getLocalEulerAngles();document.getElementById("editEntityRotX").value=t.x,document.getElementById("editEntityRotY").value=t.y,document.getElementById("editEntityRotZ").value=t.z}"localScale"in e&&(document.getElementById("editEntitySclX").value=e.localScale.x,document.getElementById("editEntitySclY").value=e.localScale.y,document.getElementById("editEntitySclZ").value=e.localScale.z)};$(function(){document.getElementById("editEntitySelectButton").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas").context.root.findByName("Player"),n=t.script.movement,i=t.script.raycast,o=t.script.transform;n.disableInput(),i.enableInput(),o.disableInput(),i.modeFramebuffer(),document.getElementById("modeLabel").innerHTML="Select Mode",document.getElementById("modeLabel").className="label label-mode-select";i.on("hit",function(e){document.getElementById("editEntityId").value=e.id,populateInputsForSelectedEntity(e),n.enableInput(),i.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement"})},!1)}),$(function(){document.getElementById("moveLink").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var i=t.entities[n],o=t.context.root.findByName("Player"),a=o.script.movement,c=o.script.raycast,l=o.script.transform;a.disableInput(),c.disableInput(),l.modeMove(),l.setEntity(i),l.enableInput(),document.getElementById("modeLabel").innerHTML="Translate Mode",document.getElementById("modeLabel").className="label label-mode-translate",l.on("move",function(e){"localPosition"in i&&(document.getElementById("editEntityPosX").value=i.localPosition.x,document.getElementById("editEntityPosY").value=i.localPosition.y,document.getElementById("editEntityPosZ").value=i.localPosition.z)})}else alert("Select an Entity first.")},!1)}),$(function(){document.getElementById("rotateLink").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var i=t.entities[n],o=t.context.root.findByName("Player"),a=o.script.movement,c=o.script.raycast,l=o.script.transform;a.disableInput(),c.disableInput(),l.modeRotate(),l.setEntity(i),l.enableInput(),document.getElementById("modeLabel").innerHTML="Rotate Mode",document.getElementById("modeLabel").className="label label-mode-rotate",l.on("rotate",function(e){if("localRotation"in i){var t=i.getLocalEulerAngles();document.getElementById("editEntityRotX").value=t.x,document.getElementById("editEntityRotY").value=t.y,document.getElementById("editEntityRotZ").value=t.z}})}else alert("Select an Entity first.")},!1)}),$(function(){document.getElementById("scaleLink").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var i=t.entities[n],o=t.context.root.findByName("Player"),a=o.script.movement,c=o.script.raycast,l=o.script.transform;a.disableInput(),c.disableInput(),l.modeScale(),l.setEntity(i),l.enableInput(),document.getElementById("modeLabel").innerHTML="Scale Mode",document.getElementById("modeLabel").className="label label-mode-scale",l.on("scale",function(e){"localScale"in i&&(document.getElementById("editEntitySclX").value=i.localScale.x,document.getElementById("editEntitySclY").value=i.localScale.y,document.getElementById("editEntitySclZ").value=i.localScale.z)})}else alert("Select an Entity first.")},!1)}),$(function(){var e=document.getElementById("editEntityId");e.addEventListener("blur",function(t){var n=pc.Application.getApplication("application-canvas");e.value in n.entities&&populateInputsForSelectedEntity(n.entities[e.value])},!1)}),$(function(){document.getElementById("editEntityProofButton").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var i=t.entities[n],o=t.context.root.findByName("Player"),a=o.script.movement,c=o.script.raycast,l=o.script.transform;a.enableInput(),c.disableInput(),l.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement";var d=document.getElementById("editEntityPosX").value,r=document.getElementById("editEntityPosY").value,s=document.getElementById("editEntityPosZ").value,m=document.getElementById("editEntityRotX").value,u=document.getElementById("editEntityRotY").value,p=document.getElementById("editEntityRotZ").value,y=document.getElementById("editEntitySclX").value,v=document.getElementById("editEntitySclY").value,E=document.getElementById("editEntitySclZ").value;$.isNumeric(d)&&$.isNumeric(r)&&$.isNumeric(s)&&$.isNumeric(m)&&$.isNumeric(u)&&$.isNumeric(p)&&$.isNumeric(y)&&$.isNumeric(v)&&$.isNumeric(E)?(i.setLocalPosition(new pc.Vec3(d,r,s)),i.setLocalEulerAngles(new pc.Vec3(m,u,p)),i.setLocalScale(new pc.Vec3(y,v,E))):alert("Values must be numeric.")}else alert("Select an Entity first.")},!1)}),$(function(){document.getElementById("removeEntityButton").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var i=t.entities[n],o=document.getElementById("editFormResultContainer");o.appendChild(document.createTextNode("Removing..."));var a=new XMLHttpRequest;a.open("DELETE","api/entity/"+n,!0),a.onload=function(e){200==a.status?(i.destroy(),delete t.entities[n],o.appendChild(document.createTextNode(a.responseText))):o.appendChild(document.createTextNode("Error occurred. "+a.responseText))},a.send(),e.preventDefault()}else alert("Select an Entity first.")},!1)}),$(function(){var e=document.forms.namedItem("contact");e.addEventListener("submit",function(t){var n=new FormData(e),i=new XMLHttpRequest;i.open("POST","api/feedback",!0),i.onload=function(e){200==i.status?(alert("Feedback sent - Thank you"),$("#contactModal").modal("hide")):alert("Error occurred. "+i.responseText)},i.send(n),t.preventDefault()},!1)}),$(function(){var e=document.getElementById("application-canvas");e.addEventListener("click",function(t){e.focus()},!1)});