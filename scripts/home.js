/*! cybers-cafe 2020-04-16 */

"use strict";var draweropen=!1;function drawer(){draweropen?(setTimeout(function(){$("#interface-div").css("visibility","hidden")},400),$("#drawer-icon-div").css("visibility","visible"),$("#interface-div").animate({opacity:0},400),draweropen=!1):($("#interface-div").css("visibility","visible"),$("#drawer-icon-div").css("visibility","hidden"),$("#interface-div").animate({opacity:1},400),draweropen=!0)}function warp(e){if(e.match(/^[0-9a-zA-Z]+$/)){var t=pc.Application.getApplication("application-canvas"),n=t.context,i=n.root.findByName("Player").script.movement,o=n.root.findByName("scene").script.network,a=parseInt(e,36),l=MathUtils.zReverseCantorPair(a);console.log("##### Warp to: ["+l+"] ("+a+") '"+e+"'"),console.log("Current loc: "+i.locationX+", "+i.locationZ),console.log("Current breadcrumb: "+i.locationBreadcrumbVector[0]+", "+i.locationBreadcrumbVector[1]),console.log("Current origin: "+o.origin);var c=[l[0]-o.origin[0],l[1]-o.origin[1]];i.locationX=l[0],i.locationZ=l[1],i.createTileGrid(i.range,i.scale),i.locationBreadcrumbVector[0]+=c[0],i.locationBreadcrumbVector[1]+=c[1],o.origin[0]=l[0],o.origin[1]=l[1],Object.keys(t.entities).forEach(function(e){var n=t.entities[e].getLocalPosition(),i={};i.x=n.x-c[0]*Network.scale,i.y=n.y,i.z=n.z-c[1]*Network.scale,Math.abs(l[0]-i.x)<50||Math.abs(l[1]-i.z)<50?"rigidbody"in t.entities[e]?t.entities[e].rigidbody.teleport(i.x,i.y,i.z):t.entities[e].translate(-c[0]*Network.scale,0,-c[1]*Network.scale):(t.entities[e].destroy(),delete t.entities[e])}),o.players||(o.players=[]),Object.keys(o.players).forEach(function(e){if("entity"in o.players[e]){var t=o.players[e].entity.getLocalPosition(),n={};n.x=t.x-c[0]*Network.scale,n.y=t.y,n.z=t.z-c[1]*Network.scale,Math.abs(l[0]-n.x)<50||Math.abs(l[1]-n.z)<50?o.players[e].entity.rigidbody.teleport(n.x,n.y,n.z):o.players[e].entity.destroy()}}),o.player.rigidbody.teleport(0,.5,0),o.updatePosition()}else alert("Alphanumeric names only.")}$(function(){document.getElementById("warpToButton").addEventListener("click",function(e){warp($("#warpToInput").val())},!1)});var sections=["createSection","editSection"];function selectSection(e){for(var t=0;t<sections.length;t++)document.getElementById(sections[t]).style.display="none";document.getElementById(e).style.display="block"}var createForms=["createEntityImageForm","createEntityModelForm","createEntityHyperlinkForm"],editForms=["editEntityMoveForm","editEntityRotateForm","editEntityScaleForm"];function selectForm(e){for(var t=e.startsWith("create")?createForms:editForms,n=0;n<t.length;n++)document.getElementById(t[n]).style.display="none";document.getElementById(e).style.display="block"}function entityPlacement(e){var t=e.target,n=t.entry,i=pc.Application.getApplication("application-canvas").context,o=i.root.findByName("Player"),a=o.script.movement,l=o.script.raycast,c=o.script.transform;a.disableInput(),l.enableInput(),c.disableInput(),l.modeRaycast(),document.getElementById("modeLabel").innerHTML="Placement Mode",document.getElementById("modeLabel").className="label label-mode-placement",a.mode="placement";var d=i.root.findByName("scene").script.network,r=!1;l.on("hit",function(e){if(!r){r=!0,"assets"in n&&Object.keys(n.assets).forEach(function(e){d.queue.enqueue(new QueueItem("asset",n.assets[e])),d.isQueueRunning||d.popQueue()});var i=[e.point.x,e.point.y,e.point.z],o=MathUtils.getAbsolutePosition(i,d.origin,a.scale);if(0!=d.origin[0]||0!=d.origin[1]){var c=[a.locationX-d.origin[0],a.locationZ-d.origin[1]],s=MathUtils.getAbsolutePosition(i,c,Network.scale);o.position=s.position}n.entity.location=o.location,n.entity.position=o.position,d.queue.enqueue(new QueueItem("entity",n.entity)),d.isQueueRunning||d.popQueue(),a.enableInput(),l.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement",a.mode="movement",t.className+=" disabled";var m=document.getElementById("createFormResultContainer");m.appendChild(document.createTextNode("Placing entity..."));var u=new FormData;u.append("locX",o.location[0]),u.append("locZ",o.location[1]),u.append("posX",o.position[0]),u.append("posY",o.position[1]),u.append("posZ",o.position[2]);var p=new XMLHttpRequest;p.open("PUT","api/entities/position/"+n.entity.id,!0),p.onload=function(e){if(200==p.status){var t=JSON.parse(p.responseText);m.appendChild(document.createTextNode(t.message))}else m.appendChild(document.createTextNode("Error occurred. ")),t&&m.appendChild(document.createTextNode(t.message))},p.send(u)}})}function createPlacementButton(e,t){var n=document.createElement("button");n.type="button",n.className="list-group-item",n.appendChild(document.createTextNode(e.name+" : "+e.id)),n.addEventListener("click",entityPlacement),n.entry={entity:e,assets:t},document.getElementById("entityChooseList").appendChild(n)}function makeGlbEntity(e,t){var n=pc.Application.getApplication("application-canvas");n.assets.loadFromUrl(e.file.url,"binary",function(e,i){if(e)return t(e);var o=i.resource;loadGlb(o,n.graphicsDevice,function(e,o){if(e)return t(e);var a=new pc.Asset("gltf","model",{url:i.file.url});a.resource=o.model,a.file={hash:i.file.hash,fullPath:i.file.fullPath,filename:i.file.filename,size:i.file.size,url:i.file.url},a.id=i.id,a.name=i.name,a.loaded=!0,n.assets.add(a);var l=new pc.Entity("gltf");l.addComponent("model",{asset:a}),t(null,l,a)})})}$(function(){var e=document.forms.namedItem("createEntityModel");e.addEventListener("submit",function(t){var n=document.getElementById("createFormResultContainer"),i=new FormData(e);n.innerHTML="Uploading...";var o=new XMLHttpRequest;o.open("POST","api/fbx",!0),o.onload=function(e){if(200==o.status){var t=JSON.parse(o.responseText);n.appendChild(document.createTextNode(t.message)),t.records&&Object.keys(t.records).forEach(function(e){if("undefined"!=e){var i=t.records[e].objectId,o=t.entities[i];makeGlbEntity(t.assets[o.components.model.asset.id],function(t,o,a){if(t)n.appendChild(document.createTextNode("Error occurred. "+t));else{o.id=e,o.objectId=i;var l={};l[a.id]=a,createPlacementButton(o,l),n.appendChild(document.createTextNode("Ready to place entity..."))}})}})}else n.appendChild(document.createTextNode("Error occurred. "+t.message))},o.send(i),t.preventDefault()},!1)}),$(function(){var e=document.forms.namedItem("createEntityImage");e.addEventListener("submit",function(t){var n=document.getElementById("createFormResultContainer"),i=new FormData(e);n.innerHTML="Uploading...";var o=new XMLHttpRequest;o.open("POST","api/image",!0),o.onload=function(e){if(200==o.status){var t=JSON.parse(o.responseText);n.appendChild(document.createTextNode(t.message));var i=Object.keys(t.records)[0],a=t.records[i].objectId,l=t.entities[a],c=t.assets;l.id=i,l.objectId=t.records[i].objectId,createPlacementButton(l,c),n.appendChild(document.createTextNode("Ready to place entity..."))}else n.appendChild(document.createTextNode("Error occurred. "+t.message))},o.send(i),t.preventDefault()},!1)}),$(function(){var e=document.forms.namedItem("createEntityHyperlink");e.addEventListener("submit",function(t){var n=document.getElementById("createFormResultContainer"),i=new FormData(e);n.innerHTML="Uploading...";var o=new XMLHttpRequest;o.open("POST","api/hyperlink",!0),o.onload=function(e){if(200==o.status){var t=JSON.parse(o.responseText);n.appendChild(document.createTextNode(t.message));var i=Object.keys(t.records)[0],a=t.records[i].objectId,l=t.entities[a],c=t.assets;l.id=i,l.objectId=t.records[i].objectId,createPlacementButton(l,c),n.appendChild(document.createTextNode("Ready to place entity..."))}else n.appendChild(document.createTextNode("Error occurred. "+t.message))},o.send(i),t.preventDefault()},!1)}),$(function(){var e=document.forms.namedItem("editEntity");e.addEventListener("submit",function(t){var n=document.getElementById("editFormResultContainer"),i=new FormData(e),o=pc.Application.getApplication("application-canvas"),a=document.getElementById("editEntityId").value;if(!($.isNumeric(a)&&a in o.entities))return alert("Select an Entity first."),void t.preventDefault();var l=o.context.root.findByName("Player"),c=l.script.movement,d=o.context.root.findByName("scene").script.network,r=l.script.raycast,s=l.script.transform,m=[i.get("posX"),i.get("posY"),i.get("posZ")],u=MathUtils.getAbsolutePosition(m,d.origin,c.scale);i.set("locX",u.location[0]),i.set("locZ",u.location[1]),i.set("posX",u.position[0]),i.set("posY",u.position[1]),i.set("posZ",u.position[2]),n.innerHTML="Updating...",c.enableInput(),r.disableInput(),s.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement",c.mode="movement";var p=new XMLHttpRequest;p.open("PUT","api/entity/"+i.get("id"),!0),p.onload=function(e){var t=JSON.parse(p.responseText);200==p.status?n.innerHTML=t.message:n.innerHTML=void 0!=t?"Error occurred ("+p.status+"): <br />"+t.message:"Error occurred ("+p.status+"): <br />"+p.responseText},p.send(i),t.preventDefault()},!1)});var populateInputsForSelectedEntity=function(e){if(document.getElementById("editEntityTitle").value=e.name,"localPosition"in e&&(document.getElementById("editEntityPosX").value=e.localPosition.x,document.getElementById("editEntityPosY").value=e.localPosition.y,document.getElementById("editEntityPosZ").value=e.localPosition.z),"localRotation"in e){var t=e.getLocalEulerAngles();document.getElementById("editEntityRotX").value=t.x,document.getElementById("editEntityRotY").value=t.y,document.getElementById("editEntityRotZ").value=t.z}"localScale"in e&&(document.getElementById("editEntitySclX").value=e.localScale.x,document.getElementById("editEntitySclY").value=e.localScale.y,document.getElementById("editEntitySclZ").value=e.localScale.z)};$(function(){document.getElementById("editEntitySelectButton").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas").context.root.findByName("Player"),n=t.script.movement,i=t.script.raycast,o=t.script.transform;n.disableInput(),i.enableInput(),o.disableInput(),i.modeFramebuffer(),document.getElementById("modeLabel").innerHTML="Select Mode",document.getElementById("modeLabel").className="label label-mode-select",n.mode="select";i.on("hit",function(e){document.getElementById("editEntityId").value=e.id,populateInputsForSelectedEntity(e),n.enableInput(),i.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement",n.mode="movement"})},!1)}),$(function(){document.getElementById("moveLink").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var i=t.entities[n],o=t.context.root.findByName("Player"),a=o.script.movement,l=o.script.raycast,c=o.script.transform;a.disableInput(),l.disableInput(),c.modeMove(),c.setEntity(i),c.enableInput(),document.getElementById("modeLabel").innerHTML="Translate Mode",document.getElementById("modeLabel").className="label label-mode-translate",a.mode="translate",c.on("move",function(e){"localPosition"in i&&(document.getElementById("editEntityPosX").value=i.localPosition.x,document.getElementById("editEntityPosY").value=i.localPosition.y,document.getElementById("editEntityPosZ").value=i.localPosition.z)})}else alert("Select an Entity first.")},!1)}),$(function(){document.getElementById("rotateLink").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var i=t.entities[n],o=t.context.root.findByName("Player"),a=o.script.movement,l=o.script.raycast,c=o.script.transform;a.disableInput(),l.disableInput(),c.modeRotate(),c.setEntity(i),c.enableInput(),document.getElementById("modeLabel").innerHTML="Rotate Mode",document.getElementById("modeLabel").className="label label-mode-rotate",a.mode="rotate",c.on("rotate",function(e){if("localRotation"in i){var t=i.getLocalEulerAngles();document.getElementById("editEntityRotX").value=t.x,document.getElementById("editEntityRotY").value=t.y,document.getElementById("editEntityRotZ").value=t.z}})}else alert("Select an Entity first.")},!1)}),$(function(){document.getElementById("scaleLink").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var i=t.entities[n],o=t.context.root.findByName("Player"),a=o.script.movement,l=o.script.raycast,c=o.script.transform;a.disableInput(),l.disableInput(),c.modeScale(),c.setEntity(i),c.enableInput(),document.getElementById("modeLabel").innerHTML="Scale Mode",document.getElementById("modeLabel").className="label label-mode-scale",a.mode="scale",c.on("scale",function(e){"localScale"in i&&(document.getElementById("editEntitySclX").value=i.localScale.x,document.getElementById("editEntitySclY").value=i.localScale.y,document.getElementById("editEntitySclZ").value=i.localScale.z)})}else alert("Select an Entity first.")},!1)}),$(function(){var e=document.getElementById("editEntityId");e.addEventListener("blur",function(t){var n=pc.Application.getApplication("application-canvas");e.value in n.entities&&populateInputsForSelectedEntity(n.entities[e.value])},!1)}),$(function(){document.getElementById("editEntityProofButton").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var i=t.entities[n],o=t.context.root.findByName("Player"),a=o.script.movement,l=o.script.raycast,c=o.script.transform;a.enableInput(),l.disableInput(),c.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement",a.mode="movement";var d=document.getElementById("editEntityPosX").value,r=document.getElementById("editEntityPosY").value,s=document.getElementById("editEntityPosZ").value,m=document.getElementById("editEntityRotX").value,u=document.getElementById("editEntityRotY").value,p=document.getElementById("editEntityRotZ").value,y=document.getElementById("editEntitySclX").value,v=document.getElementById("editEntitySclY").value,E=document.getElementById("editEntitySclZ").value;$.isNumeric(d)&&$.isNumeric(r)&&$.isNumeric(s)&&$.isNumeric(m)&&$.isNumeric(u)&&$.isNumeric(p)&&$.isNumeric(y)&&$.isNumeric(v)&&$.isNumeric(E)?(i.setLocalPosition(new pc.Vec3(d,r,s)),i.setLocalEulerAngles(new pc.Vec3(m,u,p)),i.setLocalScale(new pc.Vec3(y,v,E))):alert("Values must be numeric.")}else alert("Select an Entity first.")},!1)}),$(function(){document.getElementById("removeEntityButton").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var i=t.entities[n],o=document.getElementById("editFormResultContainer");o.appendChild(document.createTextNode("Removing..."));var a=new XMLHttpRequest;a.open("DELETE","api/entity/"+n,!0),a.onload=function(e){200==a.status?(i.destroy(),delete t.entities[n],o.appendChild(document.createTextNode(a.responseText))):o.appendChild(document.createTextNode("Error occurred. "+a.responseText))},a.send(),e.preventDefault()}else alert("Select an Entity first.")},!1)}),$(function(){var e=document.forms.namedItem("contact");e.addEventListener("submit",function(t){var n=new FormData(e),i=new XMLHttpRequest;i.open("POST","api/feedback",!0),i.onload=function(e){200==i.status?(alert("Feedback sent - Thank you"),$("#contactModal").modal("hide")):alert("Error occurred. "+i.responseText)},i.send(n),t.preventDefault()},!1)}),$(function(){var e=document.getElementById("application-canvas");e.addEventListener("click",function(t){e.focus()},!1)});