/*! cybers-cafe 2020-04-13 */

"use strict";var draweropen=!1;function drawer(){draweropen?(setTimeout(function(){$("#interface-div").css("visibility","hidden")},400),$("#drawer-icon-div").css("visibility","visible"),$("#interface-div").animate({opacity:0},400),draweropen=!1):($("#interface-div").css("visibility","visible"),$("#drawer-icon-div").css("visibility","hidden"),$("#interface-div").animate({opacity:1},400),draweropen=!0)}function warp(e){if(e.match(/^[0-9a-zA-Z]+$/)){var t=pc.Application.getApplication("application-canvas"),n=t.context,o=n.root.findByName("Player").script.movement,i=n.root.findByName("scene").script.network,a=parseInt(e,36),c=MathUtils.zReverseCantorPair(a);console.log("##### Warp to: ["+c+"] ("+a+") '"+e+"'"),console.log("Current loc: "+o.locationX+", "+o.locationZ),console.log("Current breadcrumb: "+o.locationBreadcrumbVector[0]+", "+o.locationBreadcrumbVector[1]),console.log("Current origin: "+i.origin);var l=[c[0]-i.origin[0],c[1]-i.origin[1]];o.locationX=c[0],o.locationZ=c[1],o.createTileGrid(o.range,o.scale),o.locationBreadcrumbVector[0]+=l[0],o.locationBreadcrumbVector[1]+=l[1],i.origin[0]=c[0],i.origin[1]=c[1],Object.keys(t.entities).forEach(function(e){var n=t.entities[e].getLocalPosition(),o={};o.x=n.x-l[0]*Network.scale,o.y=n.y,o.z=n.z-l[1]*Network.scale,Math.abs(c[0]-o.x)<50||Math.abs(c[1]-o.z)<50?"rigidbody"in t.entities[e]?t.entities[e].rigidbody.teleport(o.x,o.y,o.z):t.entities[e].translate(-l[0]*Network.scale,0,-l[1]*Network.scale):(t.entities[e].destroy(),delete t.entities[e])}),i.players||(i.players=[]),Object.keys(i.players).forEach(function(e){if("entity"in i.players[e]){var t=i.players[e].entity.getLocalPosition(),n={};n.x=t.x-l[0]*Network.scale,n.y=t.y,n.z=t.z-l[1]*Network.scale,Math.abs(c[0]-n.x)<50||Math.abs(c[1]-n.z)<50?i.players[e].entity.rigidbody.teleport(n.x,n.y,n.z):i.players[e].entity.destroy()}}),i.player.rigidbody.teleport(0,.5,0),i.updatePosition()}else alert("Alphanumeric names only.")}$(function(){document.getElementById("warpToButton").addEventListener("click",function(e){warp($("#warpToInput").val())},!1)});var sections=["createSection","editSection"];function selectSection(e){for(var t=0;t<sections.length;t++)document.getElementById(sections[t]).style.display="none";document.getElementById(e).style.display="block"}var createForms=["createEntityImageForm","createEntityModelForm","createEntityHyperlinkForm"],editForms=["editEntityMoveForm","editEntityRotateForm","editEntityScaleForm"];function selectForm(e){for(var t=e.startsWith("create")?createForms:editForms,n=0;n<t.length;n++)document.getElementById(t[n]).style.display="none";document.getElementById(e).style.display="block"}function entityPlacement(e){var t=e.target,n=t.entry,o=pc.Application.getApplication("application-canvas").context,i=o.root.findByName("Player"),a=i.script.movement,c=i.script.raycast,l=i.script.transform;a.disableInput(),c.enableInput(),l.disableInput(),c.modeRaycast(),document.getElementById("modeLabel").innerHTML="Placement Mode",document.getElementById("modeLabel").className="label label-mode-placement",a.mode="placement";var d=o.root.findByName("scene").script.network,r=!1;c.on("hit",function(e){if(!r){r=!0,"assets"in n&&Object.keys(n.assets).forEach(function(e){d.queue.enqueue(new QueueItem("asset",n.assets[e])),d.isQueueRunning||d.popQueue()});var o=[e.point.x,e.point.y,e.point.z],i=MathUtils.getAbsolutePosition(o,d.origin,a.scale);if(0!=d.origin[0]||0!=d.origin[1]){var l=[a.locationX-d.origin[0],a.locationZ-d.origin[1]],s=MathUtils.getAbsolutePosition(o,l,Network.scale);i.position=s.position}n.entity.location=i.location,n.entity.position=i.position,d.queue.enqueue(new QueueItem("entity",n.entity)),d.isQueueRunning||d.popQueue(),a.enableInput(),c.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement",a.mode="movement",t.className+=" disabled";var m=document.getElementById("createFormResultContainer");m.appendChild(document.createTextNode("Placing entity..."));var u=new FormData;u.append("locX",i.location[0]),u.append("locZ",i.location[1]),u.append("posX",i.position[0]),u.append("posY",i.position[1]),u.append("posZ",i.position[2]);var p=new XMLHttpRequest;p.open("PUT","api/entities/position/"+n.entity.id,!0),p.onload=function(e){if(200==p.status){var t=JSON.parse(p.responseText);m.appendChild(document.createTextNode(t.message))}else m.appendChild(document.createTextNode("Error occurred. ")),t&&m.appendChild(document.createTextNode(t.message))},p.send(u)}})}function createPlacementButton(e,t){var n=document.createElement("button");n.type="button",n.className="list-group-item",n.appendChild(document.createTextNode(e.name+" : "+e.id)),n.addEventListener("click",entityPlacement),n.entry={entity:e,assets:t},document.getElementById("entityChooseList").appendChild(n)}function makeGlbEntity(e,t){var n=pc.Application.getApplication("application-canvas");n.assets.loadFromUrl(e,"binary",function(e,o){if(e)return t(e);var i=o.resource;loadGlb(i,n.graphicsDevice,function(e,o){if(e)return t(e);var i=new pc.Asset("gltf","model",{url:""});i.resource=o.model,i.loaded=!0,n.assets.add(i),new pc.Entity("gltf").addComponent("model",{asset:i}),t(null,entity,i)})})}$(function(){var e=document.forms.namedItem("createEntityModel");e.addEventListener("submit",function(t){var n=document.getElementById("createFormResultContainer"),o=new FormData(e);n.innerHTML="Uploading...";var i=new XMLHttpRequest;i.open("POST","api/fbx",!0),i.onload=function(e){if(200==i.status){var t=JSON.parse(i.responseText);n.appendChild(document.createTextNode(t.message)),t.records&&Object.keys(t.records).forEach(function(e){if("undefined"!=e){var o=t.records[e].objectId,i=t.entities[o];i.id=e,i.objectId=o,makeGlbEntity(t.assets[i.components.model.asset.id].file.url,function(e,t,o){if(e)n.appendChild(document.createTextNode("Error occurred. "+e));else{var i={};i[o.id]=o,createPlacementButton(t,i),n.appendChild(document.createTextNode("Ready to place entity..."))}})}})}else n.appendChild(document.createTextNode("Error occurred. "+t.message))},i.send(o),t.preventDefault()},!1)}),$(function(){var e=document.forms.namedItem("createEntityImage");e.addEventListener("submit",function(t){var n=document.getElementById("createFormResultContainer"),o=new FormData(e);n.innerHTML="Uploading...";var i=new XMLHttpRequest;i.open("POST","api/image",!0),i.onload=function(e){if(200==i.status){var t=JSON.parse(i.responseText);n.appendChild(document.createTextNode(t.message));var o=Object.keys(t.records)[0],a=t.records[o].objectId,c=t.entities[a],l=t.assets;c.id=o,c.objectId=t.records[o].objectId,createPlacementButton(c,l),n.appendChild(document.createTextNode("Ready to place entity..."))}else n.appendChild(document.createTextNode("Error occurred. "+t.message))},i.send(o),t.preventDefault()},!1)}),$(function(){var e=document.forms.namedItem("createEntityHyperlink");e.addEventListener("submit",function(t){var n=document.getElementById("createFormResultContainer"),o=new FormData(e);n.innerHTML="Uploading...";var i=new XMLHttpRequest;i.open("POST","api/hyperlink",!0),i.onload=function(e){if(200==i.status){var t=JSON.parse(i.responseText);n.appendChild(document.createTextNode(t.message));var o=Object.keys(t.records)[0],a=t.records[o].objectId,c=t.entities[a],l=t.assets;c.id=o,c.objectId=t.records[o].objectId,createPlacementButton(c,l),n.appendChild(document.createTextNode("Ready to place entity..."))}else n.appendChild(document.createTextNode("Error occurred. "+t.message))},i.send(o),t.preventDefault()},!1)}),$(function(){var e=document.forms.namedItem("editEntity");e.addEventListener("submit",function(t){var n=document.getElementById("editFormResultContainer"),o=new FormData(e),i=pc.Application.getApplication("application-canvas"),a=document.getElementById("editEntityId").value;if(!($.isNumeric(a)&&a in i.entities))return alert("Select an Entity first."),void t.preventDefault();var c=i.context.root.findByName("Player"),l=c.script.movement,d=i.context.root.findByName("scene").script.network,r=c.script.raycast,s=c.script.transform,m=[o.get("posX"),o.get("posY"),o.get("posZ")],u=MathUtils.getAbsolutePosition(m,d.origin,l.scale);o.set("locX",u.location[0]),o.set("locZ",u.location[1]),o.set("posX",u.position[0]),o.set("posY",u.position[1]),o.set("posZ",u.position[2]),n.innerHTML="Updating...",l.enableInput(),r.disableInput(),s.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement",l.mode="movement";var p=new XMLHttpRequest;p.open("PUT","api/entity/"+o.get("id"),!0),p.onload=function(e){var t=JSON.parse(p.responseText);200==p.status?n.innerHTML=t.message:n.innerHTML=void 0!=t?"Error occurred ("+p.status+"): <br />"+t.message:"Error occurred ("+p.status+"): <br />"+p.responseText},p.send(o),t.preventDefault()},!1)});var populateInputsForSelectedEntity=function(e){if(document.getElementById("editEntityTitle").value=e.name,"localPosition"in e&&(document.getElementById("editEntityPosX").value=e.localPosition.x,document.getElementById("editEntityPosY").value=e.localPosition.y,document.getElementById("editEntityPosZ").value=e.localPosition.z),"localRotation"in e){var t=e.getLocalEulerAngles();document.getElementById("editEntityRotX").value=t.x,document.getElementById("editEntityRotY").value=t.y,document.getElementById("editEntityRotZ").value=t.z}"localScale"in e&&(document.getElementById("editEntitySclX").value=e.localScale.x,document.getElementById("editEntitySclY").value=e.localScale.y,document.getElementById("editEntitySclZ").value=e.localScale.z)};$(function(){document.getElementById("editEntitySelectButton").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas").context.root.findByName("Player"),n=t.script.movement,o=t.script.raycast,i=t.script.transform;n.disableInput(),o.enableInput(),i.disableInput(),o.modeFramebuffer(),document.getElementById("modeLabel").innerHTML="Select Mode",document.getElementById("modeLabel").className="label label-mode-select",n.mode="select";o.on("hit",function(e){document.getElementById("editEntityId").value=e.id,populateInputsForSelectedEntity(e),n.enableInput(),o.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement",n.mode="movement"})},!1)}),$(function(){document.getElementById("moveLink").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var o=t.entities[n],i=t.context.root.findByName("Player"),a=i.script.movement,c=i.script.raycast,l=i.script.transform;a.disableInput(),c.disableInput(),l.modeMove(),l.setEntity(o),l.enableInput(),document.getElementById("modeLabel").innerHTML="Translate Mode",document.getElementById("modeLabel").className="label label-mode-translate",a.mode="translate",l.on("move",function(e){"localPosition"in o&&(document.getElementById("editEntityPosX").value=o.localPosition.x,document.getElementById("editEntityPosY").value=o.localPosition.y,document.getElementById("editEntityPosZ").value=o.localPosition.z)})}else alert("Select an Entity first.")},!1)}),$(function(){document.getElementById("rotateLink").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var o=t.entities[n],i=t.context.root.findByName("Player"),a=i.script.movement,c=i.script.raycast,l=i.script.transform;a.disableInput(),c.disableInput(),l.modeRotate(),l.setEntity(o),l.enableInput(),document.getElementById("modeLabel").innerHTML="Rotate Mode",document.getElementById("modeLabel").className="label label-mode-rotate",a.mode="rotate",l.on("rotate",function(e){if("localRotation"in o){var t=o.getLocalEulerAngles();document.getElementById("editEntityRotX").value=t.x,document.getElementById("editEntityRotY").value=t.y,document.getElementById("editEntityRotZ").value=t.z}})}else alert("Select an Entity first.")},!1)}),$(function(){document.getElementById("scaleLink").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var o=t.entities[n],i=t.context.root.findByName("Player"),a=i.script.movement,c=i.script.raycast,l=i.script.transform;a.disableInput(),c.disableInput(),l.modeScale(),l.setEntity(o),l.enableInput(),document.getElementById("modeLabel").innerHTML="Scale Mode",document.getElementById("modeLabel").className="label label-mode-scale",a.mode="scale",l.on("scale",function(e){"localScale"in o&&(document.getElementById("editEntitySclX").value=o.localScale.x,document.getElementById("editEntitySclY").value=o.localScale.y,document.getElementById("editEntitySclZ").value=o.localScale.z)})}else alert("Select an Entity first.")},!1)}),$(function(){var e=document.getElementById("editEntityId");e.addEventListener("blur",function(t){var n=pc.Application.getApplication("application-canvas");e.value in n.entities&&populateInputsForSelectedEntity(n.entities[e.value])},!1)}),$(function(){document.getElementById("editEntityProofButton").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var o=t.entities[n],i=t.context.root.findByName("Player"),a=i.script.movement,c=i.script.raycast,l=i.script.transform;a.enableInput(),c.disableInput(),l.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement",a.mode="movement";var d=document.getElementById("editEntityPosX").value,r=document.getElementById("editEntityPosY").value,s=document.getElementById("editEntityPosZ").value,m=document.getElementById("editEntityRotX").value,u=document.getElementById("editEntityRotY").value,p=document.getElementById("editEntityRotZ").value,y=document.getElementById("editEntitySclX").value,v=document.getElementById("editEntitySclY").value,E=document.getElementById("editEntitySclZ").value;$.isNumeric(d)&&$.isNumeric(r)&&$.isNumeric(s)&&$.isNumeric(m)&&$.isNumeric(u)&&$.isNumeric(p)&&$.isNumeric(y)&&$.isNumeric(v)&&$.isNumeric(E)?(o.setLocalPosition(new pc.Vec3(d,r,s)),o.setLocalEulerAngles(new pc.Vec3(m,u,p)),o.setLocalScale(new pc.Vec3(y,v,E))):alert("Values must be numeric.")}else alert("Select an Entity first.")},!1)}),$(function(){document.getElementById("removeEntityButton").addEventListener("click",function(e){var t=pc.Application.getApplication("application-canvas"),n=document.getElementById("editEntityId").value;if($.isNumeric(n)&&n in t.entities){var o=t.entities[n],i=document.getElementById("editFormResultContainer");i.appendChild(document.createTextNode("Removing..."));var a=new XMLHttpRequest;a.open("DELETE","api/entity/"+n,!0),a.onload=function(e){200==a.status?(o.destroy(),delete t.entities[n],i.appendChild(document.createTextNode(a.responseText))):i.appendChild(document.createTextNode("Error occurred. "+a.responseText))},a.send(),e.preventDefault()}else alert("Select an Entity first.")},!1)}),$(function(){var e=document.forms.namedItem("contact");e.addEventListener("submit",function(t){var n=new FormData(e),o=new XMLHttpRequest;o.open("POST","api/feedback",!0),o.onload=function(e){200==o.status?(alert("Feedback sent - Thank you"),$("#contactModal").modal("hide")):alert("Error occurred. "+o.responseText)},o.send(n),t.preventDefault()},!1)}),$(function(){var e=document.getElementById("application-canvas");e.addEventListener("click",function(t){e.focus()},!1)});