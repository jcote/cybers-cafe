/*! cybers-cafe 2017-05-11 */

"use strict";function drawer(){draweropen?(setTimeout(function(){$("#interface-div").css("visibility","hidden")},400),$("#drawer-icon-div").css("visibility","visible"),$("#interface-div").animate({opacity:0},400),draweropen=!1):($("#interface-div").css("visibility","visible"),$("#drawer-icon-div").css("visibility","hidden"),$("#interface-div").animate({opacity:1},400),draweropen=!0)}function selectSection(a){for(var b=0;b<sections.length;b++)document.getElementById(sections[b]).style.display="none";document.getElementById(a).style.display="block"}function selectForm(a){for(var b=a.startsWith("create")?createForms:editForms,c=0;c<b.length;c++)document.getElementById(b[c]).style.display="none";document.getElementById(a).style.display="block"}function entityPlacement(a){var b=a.target,c=b.entry,d=pc.Application.getApplication("application-canvas"),e=d.context,f=e.root.findByName("Player"),g=f.script.movement,h=f.script.raycast,i=f.script.transform;g.disableInput(),h.enableInput(),i.disableInput(),h.modeRaycast(),document.getElementById("modeLabel").innerHTML="Placement Mode",document.getElementById("modeLabel").className="label label-mode-placement";var j=e.root.findByName("scene"),k=j.script.network,l=!1,m=function(a){if(!l){l=!0,"assets"in c&&Object.keys(c.assets).forEach(function(a){k.queue.enqueue(new QueueItem("asset",c.assets[a])),k.isQueueRunning||k.popQueue()});var d=[a.point.x,a.point.y,a.point.z],e=MathUtils.getAbsolutePosition(d,k.origin,g.scale);c.entity.location=e.location,c.entity.position=e.position,k.queue.enqueue(new QueueItem("entity",c.entity)),k.isQueueRunning||k.popQueue(),g.enableInput(),h.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement",b.className+=" disabled";var f=document.getElementById("createFormResultContainer");f.appendChild(document.createTextNode("Placing entity..."));var i=new FormData;i.append("locX",e.location[0]),i.append("locZ",e.location[1]),i.append("posX",e.position[0]),i.append("posY",e.position[1]),i.append("posZ",e.position[2]);var j=new XMLHttpRequest;j.open("PUT","api/entities/position/"+c.entity.id,!0),j.onload=function(a){if(200==j.status){var b=JSON.parse(j.responseText);f.appendChild(document.createTextNode(b.message))}else f.appendChild(document.createTextNode("Error occurred. ")),b&&f.appendChild(document.createTextNode(b.message))},j.send(i)}};h.on("hit",m)}function createPlacementButton(a,b){var c=document.createElement("button");c.type="button",c.className="list-group-item",c.appendChild(document.createTextNode(a.name+" : "+a.id)),c.addEventListener("click",entityPlacement),c.entry={entity:a,assets:b},document.getElementById("entityChooseList").appendChild(c)}var draweropen=!1;$(function(){var a=function(a){var b=$("#warpToInput").val();if(!b.match(/^[0-9a-zA-Z]+$/))return void alert("Alphanumeric names only.");var c=pc.Application.getApplication("application-canvas"),d=c.context,e=d.root.findByName("Player"),f=e.script.movement,g=d.root.findByName("scene"),h=g.script.network,i=parseInt(b,36),j=MathUtils.zReverseCantorPair(i);console.log("##### Warp to: ["+j+"] ("+i+") '"+b+"'"),console.log("Current loc: "+f.locationX+", "+f.locationZ),console.log("Current breadcrumb: "+f.locationBreadcrumbVector[0]+", "+f.locationBreadcrumbVector[1]),console.log("Current origin: "+h.origin);var k=[j[0]-h.origin[0],j[1]-h.origin[1]];f.locationX=j[0],f.locationZ=j[1],f.createTileGrid(f.range,f.scale),f.locationBreadcrumbVector[0]+=k[0],f.locationBreadcrumbVector[1]+=k[1],h.origin[0]=j[0],h.origin[1]=j[1],Object.keys(c.entities).forEach(function(a){var b=c.entities[a].getLocalPosition(),d={};d.x=b.x-k[0]*Network.scale,d.y=b.y,d.z=b.z-k[1]*Network.scale,Math.abs(j[0]-d.x)<50||Math.abs(j[1]-d.z)<50?"rigidbody"in c.entities[a]?c.entities[a].rigidbody.teleport(d.x,d.y,d.z):c.entities[a].translate(-k[0]*Network.scale,0,-k[1]*Network.scale):(c.entities[a].destroy(),delete c.entities[a])}),Object.keys(h.players).forEach(function(a){if("entity"in h.players[a]){var b=h.players[a].entity.getLocalPosition(),c={};c.x=b.x-k[0]*Network.scale,c.y=b.y,c.z=b.z-k[1]*Network.scale,Math.abs(j[0]-c.x)<50||Math.abs(j[1]-c.z)<50?h.players[a].entity.rigidbody.teleport(c.x,c.y,c.z):h.players[a].entity.destroy()}}),h.player.rigidbody.teleport(0,.5,0),h.updatePosition()};document.getElementById("warpToButton").addEventListener("click",a,!1)});var sections=["createSection","editSection"],createForms=["createEntityImageForm","createEntityModelForm"],editForms=["editEntityMoveForm","editEntityRotateForm","editEntityScaleForm"];$(function(){var a=function(a){var c=document.getElementById("createFormResultContainer"),d=new FormData(b);c.innerHTML="Uploading...";var e=new XMLHttpRequest;e.open("POST","api/entities",!0),e.onload=function(a){if(200==e.status){var b=JSON.parse(e.responseText);c.appendChild(document.createTextNode(b.message)),b.records&&Object.keys(b.records).forEach(function(a){if("undefined"!=a){var d=b.records[a].objectId,e=b.entities[d];e.id=a,e.objectId=d;createPlacementButton(e,b.records[a].assetIds.reduce(function(a,c){return a[c]=b.assets[c],a},{})),c.appendChild(document.createTextNode("Ready to place entity..."))}})}else c.appendChild(document.createTextNode("Error occurred. "+b.message))},e.send(d),a.preventDefault()},b=document.forms.namedItem("createEntityModel");b.addEventListener("submit",a,!1)}),$(function(){var a=function(a){var c=document.getElementById("createFormResultContainer"),d=new FormData(b);c.innerHTML="Uploading...";var e=new XMLHttpRequest;e.open("POST","api/image",!0),e.onload=function(a){if(200==e.status){var b=JSON.parse(e.responseText);c.appendChild(document.createTextNode(b.message));var d=Object.keys(b.records)[0],f=b.records[d].objectId,g=b.entities[f],h=b.assets;g.id=d,g.objectId=b.records[d].objectId,createPlacementButton(g,h),c.appendChild(document.createTextNode("Ready to place entity..."))}else c.appendChild(document.createTextNode("Error occurred. "+b.message))},e.send(d),a.preventDefault()},b=document.forms.namedItem("createEntityImage");b.addEventListener("submit",a,!1)}),$(function(){var a=function(a){var c=document.getElementById("editFormResultContainer"),d=new FormData(b),e=pc.Application.getApplication("application-canvas"),f=e.context.root.findByName("Player"),g=f.script.movement,h=e.context.root.findByName("scene"),i=h.script.network,j=[d.get("posX"),d.get("posY"),d.get("posZ")],k=MathUtils.getAbsolutePosition(j,i.origin,g.scale);d.set("locX",k.location[0]),d.set("locZ",k.location[1]),d.set("posX",k.position[0]),d.set("posY",k.position[1]),d.set("posZ",k.position[2]),c.innerHTML="Updating...";var l=new XMLHttpRequest;l.open("PUT","api/entity/"+d.get("id"),!0),l.onload=function(a){var b=JSON.parse(l.responseText);200==l.status?c.innerHTML=b.message:c.innerHTML=void 0!=b?"Error occurred ("+l.status+"): <br />"+b.message:"Error occurred ("+l.status+"): <br />"+l.responseText},l.send(d),a.preventDefault()},b=document.forms.namedItem("editEntity");b.addEventListener("submit",a,!1)});var populateInputsForSelectedEntity=function(a){if(document.getElementById("editEntityTitle").value=a.name,"localPosition"in a&&(document.getElementById("editEntityPosX").value=a.localPosition.x,document.getElementById("editEntityPosY").value=a.localPosition.y,document.getElementById("editEntityPosZ").value=a.localPosition.z),"localRotation"in a){var b=a.getLocalEulerAngles();document.getElementById("editEntityRotX").value=b.x,document.getElementById("editEntityRotY").value=b.y,document.getElementById("editEntityRotZ").value=b.z}"localScale"in a&&(document.getElementById("editEntitySclX").value=a.localScale.x,document.getElementById("editEntitySclY").value=a.localScale.y,document.getElementById("editEntitySclZ").value=a.localScale.z)};$(function(){var a=function(a){var b=pc.Application.getApplication("application-canvas"),c=b.context,d=c.root.findByName("Player"),e=d.script.movement,f=d.script.raycast,g=d.script.transform;e.disableInput(),f.enableInput(),g.disableInput(),f.modeFramebuffer(),document.getElementById("modeLabel").innerHTML="Select Mode",document.getElementById("modeLabel").className="label label-mode-select";var h=function(a){document.getElementById("editEntityId").value=a.id,populateInputsForSelectedEntity(a),e.enableInput(),f.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement"};f.on("hit",h)};document.getElementById("editEntitySelectButton").addEventListener("click",a,!1)}),$(function(){var a=function(a){var b=pc.Application.getApplication("application-canvas"),c=document.getElementById("editEntityId").value;if(!($.isNumeric(c)&&c in b.entities))return void alert("Select an Entity first.");var d=b.entities[c],e=b.context,f=e.root.findByName("Player"),g=f.script.movement,h=f.script.raycast,i=f.script.transform;g.disableInput(),h.disableInput(),i.modeMove(),i.setEntity(d),i.enableInput(),document.getElementById("modeLabel").innerHTML="Translate Mode",document.getElementById("modeLabel").className="label label-mode-translate";var j=function(a){"localPosition"in d&&(document.getElementById("editEntityPosX").value=d.localPosition.x,document.getElementById("editEntityPosY").value=d.localPosition.y,document.getElementById("editEntityPosZ").value=d.localPosition.z)};i.on("move",j)};document.getElementById("moveLink").addEventListener("click",a,!1)}),$(function(){var a=function(a){var b=pc.Application.getApplication("application-canvas"),c=document.getElementById("editEntityId").value;if(!($.isNumeric(c)&&c in b.entities))return void alert("Select an Entity first.");var d=b.entities[c],e=b.context,f=e.root.findByName("Player"),g=f.script.movement,h=f.script.raycast,i=f.script.transform;g.disableInput(),h.disableInput(),i.modeRotate(),i.setEntity(d),i.enableInput(),document.getElementById("modeLabel").innerHTML="Rotate Mode",document.getElementById("modeLabel").className="label label-mode-rotate";var j=function(a){if("localRotation"in d){var b=d.getLocalEulerAngles();document.getElementById("editEntityRotX").value=b.x,document.getElementById("editEntityRotY").value=b.y,document.getElementById("editEntityRotZ").value=b.z}};i.on("rotate",j)};document.getElementById("rotateLink").addEventListener("click",a,!1)}),$(function(){var a=function(a){var b=pc.Application.getApplication("application-canvas"),c=document.getElementById("editEntityId").value;if(!($.isNumeric(c)&&c in b.entities))return void alert("Select an Entity first.");var d=b.entities[c],e=b.context,f=e.root.findByName("Player"),g=f.script.movement,h=f.script.raycast,i=f.script.transform;g.disableInput(),h.disableInput(),i.modeScale(),i.setEntity(d),i.enableInput(),document.getElementById("modeLabel").innerHTML="Scale Mode",document.getElementById("modeLabel").className="label label-mode-scale";var j=function(a){"localScale"in d&&(document.getElementById("editEntitySclX").value=d.localScale.x,document.getElementById("editEntitySclY").value=d.localScale.y,document.getElementById("editEntitySclZ").value=d.localScale.z)};i.on("scale",j)};document.getElementById("scaleLink").addEventListener("click",a,!1)}),$(function(){var a=function(a){var c=pc.Application.getApplication("application-canvas");b.value in c.entities&&populateInputsForSelectedEntity(c.entities[b.value])},b=document.getElementById("editEntityId");b.addEventListener("blur",a,!1)}),$(function(){var a=function(a){var b=pc.Application.getApplication("application-canvas"),c=document.getElementById("editEntityId").value;if(!($.isNumeric(c)&&c in b.entities))return void alert("Select an Entity first.");var d=b.entities[c],e=b.context,f=e.root.findByName("Player"),g=f.script.movement,h=f.script.raycast,i=f.script.transform;g.enableInput(),h.disableInput(),i.disableInput(),document.getElementById("modeLabel").innerHTML="Movement Mode",document.getElementById("modeLabel").className="label label-mode-movement";var j=document.getElementById("editEntityPosX").value,k=document.getElementById("editEntityPosY").value,l=document.getElementById("editEntityPosZ").value,m=document.getElementById("editEntityRotX").value,n=document.getElementById("editEntityRotY").value,o=document.getElementById("editEntityRotZ").value,p=document.getElementById("editEntitySclX").value,q=document.getElementById("editEntitySclY").value,r=document.getElementById("editEntitySclZ").value;if(!($.isNumeric(j)&&$.isNumeric(k)&&$.isNumeric(l)&&$.isNumeric(m)&&$.isNumeric(n)&&$.isNumeric(o)&&$.isNumeric(p)&&$.isNumeric(q)&&$.isNumeric(r)))return void alert("Values must be numeric.");d.setLocalPosition(new pc.Vec3(j,k,l)),d.setLocalEulerAngles(new pc.Vec3(m,n,o)),d.setLocalScale(new pc.Vec3(p,q,r))};document.getElementById("editEntityProofButton").addEventListener("click",a,!1)}),$(function(){var a=function(a){var b=pc.Application.getApplication("application-canvas"),c=document.getElementById("editEntityId").value;if(!($.isNumeric(c)&&c in b.entities))return void alert("Select an Entity first.");var d=b.entities[c],e=document.getElementById("editFormResultContainer");e.appendChild(document.createTextNode("Removing..."));var f=new XMLHttpRequest;f.open("DELETE","api/entity/"+c,!0),f.onload=function(a){200==f.status?(d.destroy(),delete b.entities[c],e.appendChild(document.createTextNode(f.responseText))):e.appendChild(document.createTextNode("Error occurred. "+f.responseText))},f.send(),a.preventDefault()};document.getElementById("removeEntityButton").addEventListener("click",a,!1)}),$(function(){var a=function(a){var c=new FormData(b),d=new XMLHttpRequest;d.open("POST","api/feedback",!0),d.onload=function(a){200==d.status?(alert("Feedback sent - Thank you"),$("#contactModal").modal("hide")):alert("Error occurred. "+d.responseText)},d.send(c),a.preventDefault()},b=document.forms.namedItem("contact");b.addEventListener("submit",a,!1)}),$(function(){var a=function(a){b.focus()},b=document.getElementById("application-canvas");b.addEventListener("click",a,!1)});